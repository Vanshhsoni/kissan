{% extends 'base.html' %}
{% load static %}
{% block title %}Kerala — Farmer Schemes{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
  <!-- header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Kerala — Farmer & Farming Schemes</h1>
      <p class="text-lg text-gray-600"> Total schemes: {{ total }}</p>
    </div>
  </div>

  <!-- schemes grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for scheme in schemes_page %}
    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300">
      <!-- scheme header -->
      <div class="flex justify-between items-start mb-4">
        <h2 class="text-xl font-bold text-gray-800 leading-tight">{{ scheme.name }}</h2>
        <span class="text-xs px-3 py-1 rounded-full bg-green-100 border border-green-200 text-green-700 font-medium ml-2 flex-shrink-0">
          {{ scheme.category }}
        </span>
      </div>

      <!-- department -->
      <div class="mb-4 p-3 bg-gray-50 rounded-lg">
        <p class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <i data-lucide="building-2" class="w-4 h-4"></i>
          विभाग / Department:
        </p>
        <p class="text-sm text-gray-600 mt-1">{{ scheme.department }}</p>
      </div>

      <!-- eligibility -->
      <div class="mb-4">
        <details class="group">
          <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-green-600 transition-colors flex items-center">
            <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i>
            पात्रता / Eligibility & Key Points
            <i data-lucide="chevron-right" class="w-4 h-4 ml-2 transform group-open:rotate-90 transition-transform"></i>
          </summary>
          <div class="mt-3 p-3 bg-blue-50 rounded-lg">
            <p class="text-sm leading-relaxed text-gray-700">{{ scheme.eligibility|default:"जानकारी उपलब्ध नहीं है / Information not available" }}</p>
          </div>
        </details>
      </div>

      <!-- benefits -->
      <div class="mb-6">
        <details class="group">
          <summary class="cursor-pointer text-sm font-semibold text-gray-700 hover:text-green-600 transition-colors flex items-center">
            <i data-lucide="gift" class="w-4 h-4 mr-2"></i>
            लाभ / Benefits
            <i data-lucide="chevron-right" class="w-4 h-4 ml-2 transform group-open:rotate-90 transition-transform"></i>
          </summary>
          <div class="mt-3 p-3 bg-green-50 rounded-lg">
            <p class="text-sm leading-relaxed text-gray-700">{{ scheme.benefits|default:"जानकारी उपलब्ध नहीं है / Information not available" }}</p>
          </div>
        </details>
      </div>

      <!-- action button -->
      <div class="pt-4 border-t border-gray-100">
        <a href="javascript:void(0)" onclick="openSecureLink('{{ scheme.link|escapejs }}')" 
           class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors">
          <i data-lucide="external-link" class="w-4 h-4"></i>
          Official Website
        </a>
      </div>
    </div>
    {% empty %}
      <div class="col-span-full text-center py-12">
        <div class="max-w-md mx-auto">
          <i data-lucide="clipboard" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No Schemes Found</h3>
          <p class="text-gray-500">कोई योजना नहीं मिली। CSV file को जांचें।</p>
          <p class="text-sm text-gray-400 mt-2">Make sure CSV exists at <code>data/kerala_schemes.csv</code></p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- pagination -->
  {% if schemes_page.paginator.num_pages > 1 %}
  <div class="mt-10 flex items-center justify-center">
    <nav class="flex items-center space-x-4">
      {% if schemes_page.has_previous %}
        <a href="?page={{ schemes_page.previous_page_number }}" 
           class="px-6 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2">
          <i data-lucide="chevron-left" class="w-4 h-4"></i>
          Previous
        </a>
      {% endif %}
      
      <div class="flex items-center space-x-2">
        <span class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg">
          Page {{ schemes_page.number }} of {{ schemes_page.paginator.num_pages }}
        </span>
      </div>
      
      {% if schemes_page.has_next %}
        <a href="?page={{ schemes_page.next_page_number }}" 
           class="px-6 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors flex items-center gap-2">
          Next
          <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </a>
      {% endif %}
    </nav>
  </div>
  {% endif %}
</div>

<script>
  // Function to open links securely with HTTPS
  function openSecureLink(url) {
    if (!url || url.trim() === '' || url === 'N/A' || url === 'n/a') {
      alert('लिंक उपलब्ध नहीं है / Link not available');
      return;
    }
    
    // Clean and prepare URL
    let cleanUrl = url.trim();
    
    // Remove any contentReference patterns or similar
    if (cleanUrl.includes('contentReference') || cleanUrl.includes('oaicite')) {
      alert('लिंक उपलब्ध नहीं है / Link not available');
      return;
    }
    
    // Add https:// if protocol is missing
    if (!cleanUrl.match(/^https?:\/\//)) {
      cleanUrl = 'https://' + cleanUrl;
    }
    
    // Open in new tab with security features
    try {
      const newWindow = window.open(cleanUrl, '_blank', 'noopener,noreferrer');
      
      // Fallback if popup blocked
      if (!newWindow) {
        alert('पॉपअप ब्लॉक हो गया। कृपया manually link खोलें / Popup blocked. Please open link manually: ' + cleanUrl);
      }
    } catch (error) {
      console.error('Error opening link:', error);
      alert('लिंक खोलने में समस्या हुई / Error opening link');
    }
  }

  // Add loading state for links
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Add click handlers to all official links
    const officialLinks = document.querySelectorAll('a[onclick^="openSecureLink"]');
    officialLinks.forEach(link => {
      link.addEventListener('click', function() {
        // Add loading state
        const originalContent = this.innerHTML;
        this.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-2"></i>Opening...';
        this.style.pointerEvents = 'none';
        
        // Re-initialize lucide icons for the loading spinner
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
        
        // Reset after 2 seconds
        setTimeout(() => {
          this.innerHTML = originalContent;
          this.style.pointerEvents = 'auto';
          // Re-initialize lucide icons
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 2000);
      });
    });
  });
</script>

<style>
/* Additional custom styles for better farmer UX */
.scheme-card {
  transition: all 0.3s ease;
}

.scheme-card:hover {
  transform: translateY(-2px);
}

/* Better button styles */
button, .btn {
  cursor: pointer;
  user-select: none;
}

/* Smooth animations */
details summary {
  transition: all 0.2s ease;
}

details[open] summary {
  color: #059669;
}

/* Loading animation */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Responsive text */
@media (max-width: 768px) {
  h1 { font-size: 1.75rem !important; }
  .scheme-card { padding: 1rem !important; }
}

/* Ensure lucide icons are properly sized */
[data-lucide] {
  width: 1rem;
  height: 1rem;
}
</style>

<!-- Make sure to include Lucide icons in your base.html or here -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
{% endblock %}